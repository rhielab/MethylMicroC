# Methyl-Micro-C data analysis

## Citation

Gonzalez-Smith et al. Methyl-Micro-C: Simultaneous characterization of chromatin accessibility, interaction, and DNA methylation.

## Raw data processing

For Methyl-Micro-C, NOMe-HiC, and Methyl-HiC data processing, we first aligned paired-end reads using a modified version of the [Bhmem](https://bitbucket.org/dnaase/bisulfitehic) tool (doi: [10.1038/s41592-019-0502-z](https://doi.org/10.1038/s41592-019-0502-z)) using the following parameters:

```bash
./bisulfitehicMap $REFERENCE_SEQUENCE $OUTPUT_BAM $FASTQ_1 $FASTQ_2 --rgId MMC.Mod1 --rgSm MMC.Mod1 --cpu $SLURM_CPUS_PER_TASK --mem $MAXMEM_GB -outputCisReads yes -outputTransReads yes
```

We added options to allow the user to select whether to output cis and/or trans read pairs and whether to output them to a separate file, as well as code to output the number of read pairs of each type.

Our modifications (based on Git commit `04680506dd403cc078b58a8748b87c909c83068d` of https://bitbucket.org/dnaase/bisulfitehic) are available in the file `bhmem_modifications.patch`. To apply them, run `patch -p1 < /path/to/bhmem_modifications.patch` in the Bhmem source directory before compiling it.

For Micro-C data, we aligned paired-end reads using the parameters in the Hi-C Processing Pipeline outlined by the 4D Nucleome Data Coordination and Integration Center (4DN).

After alignment, all interaction data were processed and produced with software and parameters outlined by the 4D Nucleome Data Coordination and Integration Center (4DN).

Loops were called on Hi-C data using the [Mustache](https://github.com/ay-lab/mustache) R package.

Valid read pairs were defined as pairs with interaction distances of 1 kb or greater.

All methylation data paired end reads were aligned using the [bwa-meth](https://github.com/brentp/bwa-meth) alignment program. Alignments were sorted by the [samtools](https://github.com/samtools/samtools) sort function, then duplicates were identified by the [Picard](https://github.com/broadinstitute/picard) MarkDuplicates function. Reads were piled-up by the [biscuit](https://github.com/zhou-lab/biscuit) pileup function, creating a .bed file of CpG methylation reads.

## Read pair statistics
To calculate the number of read pairs that are greater than 20kb, 50kb, 100kb, 500kb, and 1Mb apart, we used version 0.3.0 of [Pairtools](https://github.com/open2c/pairtools). We modified the `pairtools/pairtools_stats.py` script to output these statistics since the original script only outputs the number of read pairs greater than 10kb apart at most.

Our patch to the script is available as `pairtools_stats.patch`. To apply it, run:
```bash
wget https://github.com/open2c/pairtools/raw/v0.3.0/pairtools/pairtools_stats.py
patch pairtools_stats.py < pairtools_stats.patch
```

**It requires Pairtools to be installed.**

Input for the script is a pairsam file generated by Pairtools.

It should be used as follows:
```bash
python3 pairtools_stats.py --output output.tsv input.pairsam
```

## Subsetting aligned reads

To compare methods and replicates, we subsetted the **unsorted** aligned .bam files to the number of reads required using the `subset_bam_file.sh` script. The script takes reads from the beginning of the file and does not randomly sample reads, and therefore the input .bam file must be unsorted to get a random sample.

It should be used as follows:
```bash
./subset_bam_file.sh number_of_reads input.bam output.bam
```

For Figure 1D-F, we subsetted the reads from cis read pairs (generated by the modified version of Bhmem with the options `-outputCisReads yes -outputTransReads no`) to 2,058,997 aligned reads (the maximum number of aligned reads in the shallowest library).

For Supplementary Figure S6, we subsetted the files to 50,000,000 aligned reads.

## Valid read pair and bridge analysis

We used the `bridge_analysis.sh` script to perform the bridge analysis.

**It requires Samtools to be installed (version 1.9 was used).**

Input for the script is an alignment BAM file that was generated by either the modified version of Bhmem or [BWA](https://github.com/lh3/bwa), as described above.

The following bridge sequences should be present in Micro-C data:

* Micro-C Bridge (Read 1 & Read 2, palindromic): `AGGTTCGTCCATCGATCGATGGACGAACCT`

* Methyl-Micro-C Bridge (Micro-C Bridge Bisulfite-Converted, Read 1): `AGGTTTGTTTATTGATTGATGGATGAATTT`

* Methyl-Micro-C Bridge (Micro-C Bridge Reverse-Complement of Read 1 after whole-genome methylation sequencing library generation, Read 2): `AAATTCATCCATCAATCAATAAACAAACCT`

These sequences were given to us by Dovetail Genomics (now part of Cantata Bio).

The script should be used as follows:

* For Methyl-Micro-C:
  ```bash
  ./bridge_analysis.sh output_folder input.bam output_filename_prefix MMC
  ```

* For Micro-C:
  ```bash
  ./bridge_analysis.sh output_folder input.bam output_filename_prefix Micro-C
  ```

**For Methyl-Micro-C libraries, the bridge sequence will be converted, so ensure that you use the correct option (MMC or Micro-C) according to the generated data.**

The following output files will be generated in the specified output folder. These can be individually processed beginning at the pairtools step of the 4DN pipeline to generate data.
* `<output_folder>/<output_filename_prefix>.withbridge.bam`
* `<output_folder>/<output_filename_prefix>.withoutbridge.bam`

## MNase signal generation

We used the `run_deeptools.sh` script to generate a trace of the signal surrounding CTCF binding regions as previously defined utilizing a bigWig file generated by the 4DN pipeline as described above.

**It requires [deepTools](https://github.com/deeptools/deepTools) to be installed (version 3.3.0 was used).**

It should be used as follows:

```bash
./run_deeptools.sh input_bigwig.bw regions_of_interest.bed output_file_prefix distance_surrounding_regions number_of_CPU_cores_to_use
```
The script generates a matrix in `<output_file_prefix>.gz` which is then used to generate a heatmap in `<output_file_prefix.pdf>`.

The following options were used to generate the figure:

```bash
./run_deeptools.sh hg38_22Rv1.NOMe.combined.HCG.bw ENCODE1_22Rv1_CTCF_chip_seq.filt.nodup.srt.MACS2_summits.bed 22Rv1.NOMe.22Rv1.CTCF_motif_in.1kb.RPKM 1000 16
```

## DNA methylation levels surrounding nucleosome-depleted regions

We used [Bis-plot](https://github.com/dnaase/Bis-tools/tree/master/Bis-plot) (version 0.90) to generate a density plot of the methylation levels surrounding nucleosome-depleted regions, as previously defined, utilizing a bigWig file generated by the methylation pipeline as described above.

We used the `run_bis-plot.sh` script to generate the density plot. The following options were used:

```bash
./run_bis-plot.sh output_directory 22Rv1_NDR_Mod1 hg38_MMC.Mod1.combined.CG.noCounts.percent.bw hg38_22Rv1.NOMe.combined.GCH.noCounts.percent.bw 22Rv1_NDR_top150k.consensus.bed NDR CTCF
```

## DNA methylation value correlation analysis

We used the `correlation_analysis.R` script to generate a heatmap comparing DNA methylation levels between 22Rv1 MMC and WGMS data, which also includes the correlation coefficient, the $R^2$ value, and the number of CpGs shared between the datasets.

Input for the script is the methylation .bed files that were generated by the methylation pipeline. Columns 1 and 2 of the files should be the chromosome name and CpG start coordinate, and columns 7 and 8 should be the methylation fraction and read count at each CpG, respectively.

The script should be used as follows:
```bash
Rscript correlation_analysis.R methylation_data_1.bed methylation_data_2.bed min_CpG_read_count_dataset_1 min_CpG_read_count_dataset_2 dataset_1_label dataset_2_label output_file.png
```

To generate the figure, the following arguments were used:
```bash
Rscript correlation_analysis.R MMC_methylation.bed WGMS_methylation.bed 10 20 "MMC Modification 1" "NOMe-seq & EM-seq" MMC_Mod1_EMseq.scatterplot.png
```

## Chromatin interaction correlation analysis

We used [HiC-Pro](https://nservant.github.io/HiC-Pro/) on Micro-C and Methyl-Micro-C data to generate normalized interaction matrices using ICE normalization and subsetted them to only interactions matching the loops called on Hi-C data as described above. The Pearson correlation method was used to calculate the p value and correlation coefficient.

## Insulation score analysis

We used [cooltools](https://github.com/open2c/cooltools) to calculate the log2 insulation score from .mcool files at 8kb resolution in 22Rv1 combined Methyl-Micro-C and Micro-C data, following [these instructions](https://cooltools.readthedocs.io/en/latest/notebooks/insulation_and_boundaries.html). The average insulation score was calculated at TAD boundaries and their surrounding regions.

## Cis read pair coverage at CpG sites

The alignment coordinates of cis read pairs involved in loops were retrieved from the .pairsam files generated by Pairtools. Pairs with interaction distances shorter than 1kb were filtered out. CpG sites were then overlapped with the remaining reads using the [GenomicRanges](https://bioconductor.org/packages/release/bioc/html/GenomicRanges.html) R package. The significance of differences in read coverage at these CpG sites was measured using a $t$-test.
